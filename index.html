<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magic Block! — Block Blast Style</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- Biến CSS cho màu sắc và khoảng cách --- */
    :root {
      --bg-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-dark: linear-gradient(135deg, #4c63d2 0%, #5a4fcf 100%);
      --bg-secondary: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      --panel: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --panel-light: rgba(255, 255, 255, 0.1);
      --text-color: #ffffff;
      --text-secondary: #f1f5f9;
      --score-color: #ffd700;
      --accent-color: #00d4ff;
      --accent-secondary: #ff6b6b;
      --success-color: #4ade80;
      --warning-color: #fbbf24;
      --shadow-dark: rgba(0, 0, 0, 0.3);
      --shadow-light: rgba(255, 255, 255, 0.1);
    }

    /* --- Cấu hình chung và Typography --- */
    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg-main);
      color: var(--text-color);
      font-family: "Poppins", system-ui, sans-serif;
      transition: background-color 0.4s ease;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 1;
    }

    /* Ẩn thanh cuộn để trải nghiệm tốt hơn */
    body::-webkit-scrollbar {
      display: none;
    }

    body {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Hiệu ứng nhấn nút mượt mà */
    button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
    }

    /* --- Cấu trúc chính của ứng dụng --- */
    .wrap {
      max-width: 400px;
      margin: 8px auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      position: relative;
      height: calc(100% - 16px);
      box-sizing: border-box;
      user-select: none;
      z-index: 2;
      backdrop-filter: blur(10px);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- Thiết kế cho các tiêu đề và văn bản --- */
    h1,
    h2 {
      margin: 0;
      font-weight: 900;
      letter-spacing: -0.03em;
      user-select: none;
    }

    h1 {
      font-size: 28px;
      background: linear-gradient(90deg, var(--accent-color), #8be4ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
    }

    /* --- Thanh thông tin điểm số và nút --- */
    .bar {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;  /* Giảm khoảng cách để tiết kiệm không gian */
      user-select: none;
    }

    .tag {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      border-radius: 16px;
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 700;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .tag:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
      cursor: default;
    }

    .score-display {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--score-color), #ffeb3b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
      margin-top: -4px;
      user-select: none;
      letter-spacing: 0.02em;
      transition: all 0.3s ease;
      filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
    }

    .menu-btn {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px 16px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      color: var(--text-color);
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .menu-btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
    }

    .menu-btn:active {
      transform: scale(0.95);
    }

    /* --- Khu vực khay chứa khối --- */
    .tray-section {
      position: relative;
      width: 100%;
      padding-top: 10px;
      box-sizing: border-box;
    }

    /* --- Hiệu ứng bóng và góc bo tròn cho canvas --- */
    canvas {
      border-radius: 20px;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.3),
        0 8px 16px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      touch-action: none;
      display: block;
      margin-top: 8px;
      transition: all 0.3s ease;
      background: var(--bg-dark);
      image-rendering: optimizeSpeed;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: pixelated;
      max-width: 100%;
      height: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    canvas:active {
      transform: scale(0.99);
      box-shadow: 
        0 12px 24px rgba(0, 0, 0, 0.4),
        0 4px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    /* --- Các khung nhìn (Home, Game, Settings) --- */
    .views {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 0 16px;
      box-sizing: border-box;
      user-select: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    .views.active {
      opacity: 1;
      visibility: visible;
      z-index: 10;
    }

    /* --- Home View --- */
    .home-title {
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(135deg,
          #00d4ff,
          #ff6b6b,
          #4ade80,
          #fbbf24,
          #a855f7);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      letter-spacing: -0.02em;
      margin-bottom: 20px;
      animation: gradientShift 8s ease infinite;
      user-select: none;
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .home-subtitle {
      font-size: 16px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      margin-top: -12px;
      margin-bottom: 24px;
      user-select: none;
      letter-spacing: 0.1em;
      opacity: 0.9;
    }

    /* --- Nút chung --- */
    .main-btn {
      padding: 16px 40px;
      border-radius: 14px;
      font-size: 22px;
      font-weight: 900;
      border: 0;
      color: #fff;
      cursor: pointer;
      min-width: 240px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      transition: transform 0.25s ease, box-shadow 0.25s ease,
        background-color 0.3s ease;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border: 2px solid #556c9a;
    }

    .main-btn:active {
      transform: translateY(3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn-play {
      background: linear-gradient(135deg, var(--accent-color), #0ea5e9);
      box-shadow: 0 8px 24px rgba(0, 212, 255, 0.4);
    }

    .btn-play:hover {
      background: linear-gradient(135deg, #0ea5e9, var(--accent-color));
      box-shadow: 0 12px 32px rgba(0, 212, 255, 0.5);
      transform: translateY(-3px);
    }

    .btn-settings-home {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
      color: var(--text-color);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .btn-settings-home:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.15));
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
    }

    /* --- Màn hình Game Over --- */
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: all 0.4s ease;
      user-select: none;
      padding: 16px;
      box-sizing: border-box;
    }

    .overlay.show {
      visibility: visible;
      opacity: 1;
    }

    .modal {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 32px 36px;
      min-width: 300px;
      max-width: 90vw;
      text-align: center;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        0 8px 24px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-color);
      transform: scale(0.8) translateY(20px);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      user-select: none;
    }

    .overlay.show .modal {
      transform: scale(1);
    }

    .game-over-title {
      font-size: 36px;
      font-weight: 900;
      margin: 0 0 20px 0;
      background: linear-gradient(135deg, var(--accent-secondary), var(--warning-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      letter-spacing: -0.02em;
    }

    .modal-score {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--score-color), #ffeb3b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 12px;
      letter-spacing: 0.02em;
      filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.3));
    }

    .modal-best {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      margin-bottom: 24px;
      letter-spacing: 0.02em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .modal button {
      margin-top: 20px;
    }

    /* --- Menu Cài đặt --- */
    .settings-modal {
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      user-select: none;
    }

    .settings-modal h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--accent-color), var(--success-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .settings-modal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: 0;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
      transition: color 0.3s ease;
      user-select: none;
    }

    .settings-modal .close-btn:hover {
      color: #f87171;
    }

    .settings-options {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 16px;
    }

    .settings-options .btn {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
      border-radius: 18px;
      font-size: 24px;
      color: var(--text-color);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }

    .settings-options .btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
      transform: scale(1.05) translateY(-2px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    .settings-options .btn:active {
      transform: scale(0.95);
    }

    .tray-piece-wrap {
      position: relative;
      height: 100%;
      width: 100%;
    }

    .rotate-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.8), rgba(14, 165, 233, 0.8));
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
    }

    .rotate-btn:hover {
      background: linear-gradient(135deg, rgba(0, 212, 255, 1), rgba(14, 165, 233, 1));
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 6px 16px rgba(0, 212, 255, 0.5);
    }

    .rotate-btn:active {
      transform: scale(0.9);
    }
  </style>
</head>

<body>
  <div class="wrap" id="main-wrap">
    <div id="home-view" class="views active" role="main" aria-label="Trang chủ trò chơi">
      <h2 class="home-title" aria-label="Tiêu đề trò chơi Block Blast">BLOCK BLAST</h2>
      <div class="home-subtitle" aria-label="Phụ đề trò chơi">ADVENTURE MASTER</div>
      <button id="classic-btn" class="main-btn btn-play" style="
            background: linear-gradient(180deg, #51d7fb 0%, #0093e1 100%);
            margin-top: 20px;
          " aria-label="Bắt đầu chơi chế độ Classic">
        <span style="font-size: 28px; margin-right: 10px" aria-hidden="true">♾️</span>
        Classic
      </button>
      <button id="dynamic-btn" class="main-btn" style="
            background: linear-gradient(180deg, #f08080 0%, #d80000 100%);
          " aria-label="Bắt đầu chơi chế độ Dynamic">
        <span style="font-size: 28px; margin-right: 10px" aria-hidden="true">🔄</span>
        Dynamic
      </button>
    </div>

    <div id="game-view" class="views" role="main" aria-label="Khu vực chơi game">
      <div class="bar" role="region" aria-live="polite" aria-atomic="true" aria-relevant="text">
        <div class="tag" aria-label="Điểm cao nhất hiện tại">
          <i class="fas fa-crown" aria-hidden="true"></i>
          <span id="best">0</span>
        </div>
        <div class="score-display" aria-label="Điểm hiện tại">
          <span id="score">0</span>
        </div>
        <button id="pause-btn" class="menu-btn" aria-haspopup="dialog" aria-controls="pause-overlay"
          aria-label="Mở menu tạm dừng">
          <i class="fas fa-pause" aria-hidden="true"></i>
        </button>
      </div>
      <canvas id="game" role="img" aria-label="Bảng chơi game 10 trên 10 ô"></canvas>
      <div class="tray-section">
        <div class="tray-pieces-container flex justify-between w-full"></div>
      </div>
    </div>
  </div>

  <div id="gameover-overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="overlay-title"
    aria-describedby="overlay-score overlay-best">
    <div class="modal">
      <h2 id="overlay-title" class="game-over-title">Game Over</h2>
      <div class="modal-score">Điểm: <span id="overlay-score">0</span></div>
      <div class="modal-best">Kỷ lục: <span id="overlay-best">0</span></div>
      <button id="overlay-replay" class="btn-play main-btn" style="margin-top: 20px" aria-label="Chơi lại">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          style="margin-right: 8px; vertical-align: middle" aria-hidden="true" focusable="false">
          <polygon points="5 3 19 12 5 21 5 3"></polygon>
        </svg>
        Chơi lại
      </button>
    </div>
  </div>

  <div id="pause-overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="pause-title"
    aria-describedby="pause-desc">
    <div class="modal settings-modal">
      <button id="close-pause" class="close-btn" aria-label="Tiếp tục chơi">
        ✖️
      </button>
      <h2 id="pause-title">Tạm dừng</h2>
      <p id="pause-desc" class="sr-only">
        Các tùy chọn cài đặt âm thanh và điều khiển trò chơi
      </p>
      <div class="settings-options" role="group" aria-label="Tùy chọn âm thanh">
        <button id="mute-btn" class="btn" aria-pressed="true" aria-label="Bật/tắt âm thanh">
          🔊
        </button>
        <button id="bgm-btn" class="btn" aria-pressed="false" aria-label="Bật/tắt nhạc nền">
          🎵
        </button>
      </div>
      <button id="replay-in-pause" class="btn-play main-btn" aria-label="Chơi lại trò chơi">
        Chơi lại
      </button>
      <button id="back-to-home" class="btn-settings-home main-btn" aria-label="Quay về trang chủ">
        Về Home
      </button>
    </div>
  </div>

  <script>
    /* ----------------- CẤU HÌNH CỐ ĐỊNH CỦA TRÒ CHƠI ----------------- */
    const GRID = 10;
    let CELL, GAP, BOARD_PAD, BOARD_SIZE, CANVAS_W, CANVAS_H, TRAY_TOP, TRAY_HEIGHT;
    let isPaused = false;

    const COLORS = [
      "#e80000",
      "#d47006",
      "#f0bd13",
      "#18f21e",
      "#0fa8f2",
      "#1c14db",
      "#7a15ed",
      "#f5189e",
    ];
    const SHAPES = [
      [[0, 0]], // 1x1
      [[0, 0], [1, 0]], // 1x2 ngang
      [[0, 0], [0, 1]], // 1x2 dọc
      [[0, 0], [1, 0], [2, 0]], // 1x3 ngang
      [[0, 0], [0, 1], [0, 2]], // 1x3 dọc
      [[0, 0], [1, 0], [0, 1], [1, 1]], // 2x2
      [[0, 0], [1, 0], [2, 0], [3, 0]], // 1x4 ngang
      [[0, 0], [0, 1], [0, 2], [0, 3]], // 1x4 dọc
      [[0, 0], [1, 0], [2, 0], [3, 0], [4, 0]], // 1x5 ngang
      [[0, 0], [0, 1], [0, 2], [0, 3], [0, 4]], // 1x5 dọc
      [[0, 0], [1, 0], [2, 0], [1, 1]], // Khối T
      [[0, 0], [0, 1], [0, 2], [1, 2]], // Khối L (Tetromino)
      [[0, 0], [1, 0], [1, 1], [2, 1]], // Khối S (Tetromino)
      [[0, 0], [1, 0], [2, 0], [2, 1]], // Khối L ngược (J-Tetromino)
      [[0, 1], [1, 1], [2, 1], [2, 0]], // Khối J (Tetromino)
      [[0, 0], [0, 1], [1, 1], [2, 1]], // Khối Z (Tetromino)
      [[0, 0], [0, 1], [1, 0], [2, 0]], // Khối T ngược
      [
        [0, 0],
        [1, 0],
        [2, 0],
        [0, 1],
        [1, 1],
        [2, 1],
      ], // 2x3
      [
        [0, 0],
        [1, 0],
        [2, 0],
        [0, 1],
        [1, 1],
        [2, 1],
        [0, 2],
        [1, 2],
        [2, 2],
      ], // 3x3
    ];

    /* ----------------- CÁC BIẾN TRẠNG THÁI CỦA TRÒ CHƠI ----------------- */
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const bestEl = document.getElementById("best");
    const gameoverOverlay = document.getElementById("gameover-overlay");
    const pauseOverlay = document.getElementById("pause-overlay");
    const overlayScore = document.getElementById("overlay-score");
    const overlayBest = document.getElementById("overlay-best");
    const overlayReplay = document.getElementById("overlay-replay");
    const muteBtn = document.getElementById("mute-btn");
    const bgmBtn = document.getElementById("bgm-btn");
    const replayInPauseBtn = document.getElementById("replay-in-pause");
    const homeView = document.getElementById("home-view");
    const gameView = document.getElementById("game-view");
    const classicBtn = document.getElementById("classic-btn");
    const dynamicBtn = document.getElementById("dynamic-btn");
    const pauseBtn = document.getElementById("pause-btn");
    const closePauseBtn = document.getElementById("close-pause");
    const backToHomeBtn = document.getElementById("back-to-home");
    const trayPiecesContainer = document.querySelector(".tray-pieces-container");

    let board = null;
    let tray = null;
    let dragging = null;
    let dragPos = null;
    let score = 0;
    let best = parseInt(localStorage.getItem("bb_best_polished") || "0", 10) || 0;
    bestEl.textContent = best;
    let clearingAnim = null;
    let dirty = true;
    let returnAnim = null;
    let floatingTexts = [];
    let popAnims = new Map();
    let audioEnabled = true;
    let sparks = [];
    let gameoverAnim = null;
    let starParticles = [];
    let bgmAudio = null;
    let bgmEnabled = false;
    let gameMode = "classic";
    let rafId = null;

    /* ---------- ÂM THANH ---------- */
    const SOUND_URLS = {
      place: "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg",
      clear: "https://actions.google.com/sounds/v1/cartoon/pop.ogg",
      gameover: "https://actions.google.com/sounds/v1/alarms/beep_short.ogg",
      victory: "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg",
      rotate: "https://actions.google.com/sounds/v1/cartoon/boing.ogg",
      bgm: "https://actions.google.com/sounds/v1/cartoon/swish_in_and_out.ogg",
    };
    const audio = {};
    for (const k in SOUND_URLS) {
      audio[k] = new Audio(SOUND_URLS[k]);
      audio[k].preload = "auto";
    }

    function playSound(k) {
      if (!audioEnabled) return;
      try {
        const a = audio[k];
        if (a) {
          a.currentTime = 0;
          a.play().catch(() => { });
        }
      } catch (e) { }
    }

    function toggleBGM() {
      bgmEnabled = !bgmEnabled;
      if (bgmEnabled) {
        if (!bgmAudio) {
          bgmAudio = new Audio(SOUND_URLS.bgm);
          bgmAudio.loop = true;
          bgmAudio.volume = 0.5;
        }
        bgmAudio.play().catch(() => { });
        bgmBtn.textContent = "🎶";
        bgmBtn.setAttribute("aria-pressed", "true");
      } else {
        if (bgmAudio) {
          bgmAudio.pause();
        }
        bgmBtn.textContent = "🎵";
        bgmBtn.setAttribute("aria-pressed", "false");
      }
    }

    function togglePause() {
      isPaused = !isPaused;
      if (isPaused) {
        pauseOverlay.classList.add('show');
        pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        if (bgmEnabled && bgmAudio) bgmAudio.pause();
        cancelAnimationFrame(rafId);
        rafId = null;
      } else {
        pauseOverlay.classList.remove('show');
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        if (bgmEnabled && bgmAudio) bgmAudio.play().catch(() => { });
        if (!rafId) tick();
      }
    }

    /* ------------- UTILITY FUNCTIONS ------------- */
    const rand = (a) => a[Math.floor(Math.random() * a.length)];
    const now = () => performance.now();
    function cloneShape(s) {
      return s.map(([x, y]) => [x, y]);
    }
    function rotateRight(cells) {
      const rot = cells.map(([x, y]) => [y, -x]);
      const minX = Math.min(...rot.map((c) => c[0])),
        minY = Math.min(...rot.map((c) => c[1]));
      return rot.map(([x, y]) => [x - minX, y - minY]);
    }
    function boundsOf(cells) {
      const xs = cells.map((c) => c[0]),
        ys = cells.map((c) => c[1]);
      return {w: Math.max(...xs) + 1, h: Math.max(...ys) + 1};
    }
    function emptyBoard() {
      return Array.from({length: GRID}, () => Array(GRID).fill(0));
    }
    function keyOf(x, y) {
      return `${x},${y}`;
    }

    /* ------------- RESIZING ------------- */
    function resizeGame() {
      const wrap = document.getElementById("main-wrap");
      const wrapWidth = wrap.clientWidth * 0.85;
      const boardRatio = 0.75;
      const trayRatio = 0.52;
      const boardHeight = wrapWidth * boardRatio;
      const trayHeight = wrapWidth * trayRatio;

      CANVAS_W = wrapWidth;
      CANVAS_H = boardHeight + trayHeight + 40;

      CELL = (CANVAS_W * 0.82) / GRID;
      GAP = CELL * 0.08;
      CELL = (CANVAS_W * 0.82 - (GRID + 1) * GAP) / GRID;
      BOARD_SIZE = GRID * CELL + (GRID - 1) * GAP;
      BOARD_PAD = (CANVAS_W - BOARD_SIZE) / 2;

      TRAY_TOP = BOARD_PAD + BOARD_SIZE + 12;
      TRAY_HEIGHT = trayHeight * 0.95;

      canvas.width = CANVAS_W * devicePixelRatio;
      canvas.height = CANVAS_H * devicePixelRatio;
      canvas.style.width = CANVAS_W + "px";
      canvas.style.height = CANVAS_H + "px";
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.scale(devicePixelRatio, devicePixelRatio);

      dirty = true;
    }

    /* ------------- GAME LOGIC ------------- */
    function randomPiece() {
      const base = cloneShape(rand(SHAPES));
      const r = Math.floor(Math.random() * 4);
      let s = base;
      for (let i = 0; i < r; i++) s = rotateRight(s);
      return {shape: s, color: rand(COLORS), used: false, slotRect: null, rotatable: gameMode === 'dynamic'};
    }

    function layoutTray() {
      trayPiecesContainer.innerHTML = "";
      const leftPad = 8;
      const gapSlot = 8;
      const totalGap = gapSlot * 2;
      const slotW = Math.floor((CANVAS_W - leftPad * 2 - totalGap) / 3);

      for (let i = 0; i < 3; i++) {
        const x = leftPad + i * (slotW + gapSlot);
        tray[i].slotRect = {x, y: TRAY_TOP, w: slotW, h: TRAY_HEIGHT};

        const pieceDiv = document.createElement("div");
        pieceDiv.className = "tray-piece-wrap relative";
        pieceDiv.style.width = `${slotW}px`;
        pieceDiv.style.height = `${TRAY_HEIGHT}px`;
        pieceDiv.setAttribute('data-piece-index', i);

        if (tray[i].rotatable) {
          const rotateBtn = document.createElement('button');
          rotateBtn.className = "rotate-btn";
          rotateBtn.innerHTML = "🔄";
          rotateBtn.setAttribute('aria-label', `Xoay khối ${i + 1}`);
          pieceDiv.appendChild(rotateBtn);
        }
        trayPiecesContainer.appendChild(pieceDiv);
      }
      dirty = true;
    }

    function initGame(mode) {
      gameMode = mode;
      resizeGame();
      board = emptyBoard();
      tray = [randomPiece(), randomPiece(), randomPiece()];
      layoutTray();
      score = 0;
      scoreEl.textContent = score;
      clearingAnim = null;
      returnAnim = null;
      floatingTexts = [];
      sparks = [];
      popAnims.clear();
      gameoverAnim = null;
      dragging = null;
      dragPos = null;
      hideGameoverOverlay();
      hidePauseOverlay();
      isPaused = false;
      pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      dirty = true;
      if (!rafId) tick();
    }

    /* ------------- DRAWING ------------- */
    function roundedRect(x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
    }

    function drawBoardPanel() {
      ctx.fillStyle = "#3d5082";
      roundedRect(BOARD_PAD - 8, BOARD_PAD - 8, BOARD_SIZE + 16, BOARD_SIZE + 16, 16);
      ctx.shadowColor = "rgba(0,0,0,0.4)";
      ctx.shadowBlur = 16;
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.strokeStyle = "#556c9a";
      ctx.lineWidth = 3;
      roundedRect(BOARD_PAD - 8, BOARD_PAD - 8, BOARD_SIZE + 16, BOARD_SIZE + 16, 16);
      ctx.stroke();
    }

    function drawGrid() {
      for (let y = 0; y < GRID; y++) {
        for (let x = 0; x < GRID; x++) {
          const cx = BOARD_PAD + x * (CELL + GAP);
          const cy = BOARD_PAD + y * (CELL + GAP);
          const val = board[y][x];
          if (val) {
            const k = keyOf(x, y);
            let scale = 1;
            if (popAnims.has(k)) {
              const anim = popAnims.get(k);
              const t = Math.min(1, (now() - anim.start) / anim.dur);
              scale = 1 + 0.08 * (1 - Math.pow(1 - t, 2));
              if (t >= 1) popAnims.delete(k);
            }
            const s = CELL * scale,
              off = (CELL - s) / 2;
            const gx = cx + off,
              gy = cy + off;

            ctx.fillStyle = val;
            roundedRect(gx, gy, s, s, 6);
            ctx.shadowColor = "rgba(0,0,0,0.3)";
            ctx.shadowBlur = 5;
            ctx.fill();
            ctx.shadowBlur = 0;

            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 1.5;
            ctx.globalAlpha = 0.2;
            roundedRect(gx + 1, gy + 1, s - 2, s - 2, 6);
            ctx.stroke();
            ctx.globalAlpha = 1;
          } else {
            ctx.fillStyle = "#2a448c";
            roundedRect(cx, cy, CELL, CELL, 8);
            ctx.shadowColor = "rgba(0,0,0,0.15)";
            ctx.shadowBlur = 3;
            ctx.fill();
            ctx.shadowBlur = 0;
          }
        }
      }
    }

    function drawTray() {
      for (let i = 0; i < 3; i++) {
        const s = tray[i].slotRect;
        ctx.fillStyle = "rgba(0,0,0,0.25)";
        roundedRect(s.x, s.y, s.w, s.h, 12);
        ctx.shadowColor = "rgba(0,0,0,0.3)";
        ctx.shadowBlur = 10;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = "rgba(255,255,255,0.1)";
        ctx.lineWidth = 1;
        roundedRect(s.x, s.y, s.w, s.h, 12);
        ctx.stroke();
        if (!tray[i].used && !(dragging && dragging.pieceIdx === i && !returnAnim)) {
          drawPieceInSlot(tray[i], s);
        } else if (tray[i].used) {
          ctx.fillStyle = "rgba(255,255,255,0.3)";
          ctx.font = `700 ${12}px Poppins`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("Đã dùng", s.x + s.w / 2, s.y + s.h / 2);
        }
      }
    }

    function drawPieceInSlot(piece, slot, {fade = 1} = {}) {
      const {shape, color} = piece;
      const {w: shapeW, h: shapeH} = boundsOf(shape);
      
      const maxSize = Math.min(slot.w * 0.8, slot.h * 0.8);
      const cellSize = Math.min(maxSize / Math.max(shapeW, shapeH), 24);
      const gap = cellSize * 0.1;
      
      const totalW = shapeW * cellSize + (shapeW - 1) * gap;
      const totalH = shapeH * cellSize + (shapeH - 1) * gap;
      
      const startX = slot.x + (slot.w - totalW) / 2;
      const startY = slot.y + (slot.h - totalH) / 2;
      
      ctx.globalAlpha = fade;
      for (const [dx, dy] of shape) {
        const x = startX + dx * (cellSize + gap);
        const y = startY + dy * (cellSize + gap);
        
        ctx.fillStyle = color;
        roundedRect(x, y, cellSize, cellSize, 4);
        ctx.shadowColor = "rgba(0,0,0,0.3)";
        ctx.shadowBlur = 3;
        ctx.fill();
        ctx.shadowBlur = 0;
        
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 1;
        ctx.globalAlpha = fade * 0.3;
        roundedRect(x + 0.5, y + 0.5, cellSize - 1, cellSize - 1, 4);
        ctx.stroke();
        ctx.globalAlpha = fade;
      }
      ctx.globalAlpha = 1;
    }

    function draw() {
      if (!dirty) return;
      
      ctx.fillStyle = "#1e2c4a";
      ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
      
      drawBoardPanel();
      drawGrid();
      drawTray();
      
      dirty = false;
    }

    /* ------------- GAME OVER & UI ------------- */
    function showGameoverOverlay() {
      overlayScore.textContent = score;
      overlayBest.textContent = best;
      gameoverOverlay.classList.add('show');
    }

    function hideGameoverOverlay() {
      gameoverOverlay.classList.remove('show');
    }

    function hidePauseOverlay() {
      pauseOverlay.classList.remove('show');
    }

    function showView(viewName) {
      homeView.classList.toggle('active', viewName === 'home');
      gameView.classList.toggle('active', viewName === 'game');
    }

    /* ------------- GAME LOOP ------------- */
    function tick() {
      if (isPaused) return;
      
      draw();
      rafId = requestAnimationFrame(tick);
    }

    /* ------------- EVENT HANDLERS ------------- */
    classicBtn.addEventListener('click', () => {
      initGame('classic');
      showView('game');
    });

    dynamicBtn.addEventListener('click', () => {
      initGame('dynamic');
      showView('game');
    });

    pauseBtn.addEventListener('click', togglePause);
    closePauseBtn.addEventListener('click', togglePause);

    muteBtn.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      muteBtn.textContent = audioEnabled ? "🔊" : "🔇";
      muteBtn.setAttribute("aria-pressed", audioEnabled.toString());
    });

    bgmBtn.addEventListener('click', toggleBGM);

    overlayReplay.addEventListener('click', () => {
      hideGameoverOverlay();
      initGame(gameMode);
    });

    replayInPauseBtn.addEventListener('click', () => {
      hidePauseOverlay();
      initGame(gameMode);
    });

    backToHomeBtn.addEventListener('click', () => {
      hidePauseOverlay();
      showView('home');
      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
    });

    /* ------------- INITIALIZATION ------------- */
    window.addEventListener('resize', () => {
      if (gameView.classList.contains('active')) {
        resizeGame();
      }
    });

    // Initialize the game
    resizeGame();
  </script>
</body>

</html>